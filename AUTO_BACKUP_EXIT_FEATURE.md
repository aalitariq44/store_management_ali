# ميزة النسخ الاحتياطي التلقائي عند الخروج - الإصدار المحدث

## الوصف
تم إضافة ميزة جديدة لإنشاء نسخة احتياطية تلقائية عند إغلاق التطبيق. هذه الميزة تضمن عدم فقدان البيانات وحفظها في السحابة (Supabase) قبل الخروج من التطبيق.

**تحديث هام**: تم إصلاح مشكلة عدم التقاط زر الإغلاق (X) في Windows من خلال تطوير نظام Method Channel يتعامل مع رسائل Windows مباشرة.

## الميزات الجديدة

### 1. النسخ الاحتياطي التلقائي عند الإغلاق (الآن يعمل مع زر X!)
- **عند الضغط على زر الخروج (X) في نافذة Windows**: يتم التقاط الحدث على مستوى Windows ويعرض التطبيق حوار تأكيد للخروج مع النسخ الاحتياطي
- **رسالة التأكيد**: "سيتم الخروج من التطبيق بعد عمل نسخة احتياطية للبيانات"
- **مؤشر التقدم**: عرض مؤشر أثناء إنشاء النسخة الاحتياطية
- **رسائل النجاح/الفشل**: إعلام المستخدم بنتيجة العملية
- **إلغاء العملية**: يمكن للمستخدم إلغاء الخروج والعودة للتطبيق

### 2. خيار إغلاق التطبيق من القائمة
- تم إضافة خيار "إغلاق التطبيق" في قائمة الخيارات (الثلاث نقاط)
- الخيار يظهر مع أيقونة حمراء وعبارة "مع النسخ الاحتياطي"
- يمكن للمستخدم إغلاق التطبيق مباشرة من هذا الخيار

### 3. النظام التقني الجديد

#### Method Channel للتواصل مع Windows
- **خدمة WindowsMethodChannelService**: تتعامل مع رسائل Windows
- **التقاط WM_CLOSE**: يتم التقاط رسالة إغلاق النافذة من Windows مباشرة
- **تأخير الإغلاق**: منع الإغلاق الفوري والسماح لـ Flutter بالتعامل مع النسخ الاحتياطي
- **إغلاق قسري**: بعد اكتمال النسخ الاحتياطي، يتم إغلاق النافذة بالقوة

#### خدمة إدارة دورة حياة التطبيق (AppLifecycleService)
- خدمة محسنة للتعامل مع أحداث إغلاق التطبيق
- إدارة عملية النسخ الاحتياطي بطريقة آمنة
- منع تشغيل عدة نسخ احتياطية في نفس الوقت
- التعامل مع الأخطاء وعرض الرسائل المناسبة

## كيفية الاستخدام

### الطريقة الأولى: زر الإغلاق العادي (X) - الآن يعمل!
1. اضغط على زر الإغلاق (X) في أعلى يمين النافذة
2. **سيتم التقاط الحدث** وستظهر رسالة تأكيد تخبرك بأنه سيتم إنشاء نسخة احتياطية
3. اضغط "متابعة مع النسخ الاحتياطي" للموافقة أو "إلغاء" للرجوع
4. ستظهر رسالة "جاري إنشاء النسخة الاحتياطية..."
5. بعد اكتمال النسخ الاحتياطي، سيتم إغلاق التطبيق تلقائياً

### الطريقة الثانية: من قائمة الخيارات
1. اضغط على أيقونة الثلاث نقاط في شريط العلوي
2. اختر "إغلاق التطبيق"
3. ستتم نفس العملية كما في الطريقة الأولى

## الملفات المضافة/المحدثة

### ملفات جديدة:
- `lib/services/app_lifecycle_service.dart` - خدمة إدارة دورة حياة التطبيق
- `lib/services/windows_method_channel_service.dart` - خدمة التواصل مع Windows
- `AUTO_BACKUP_EXIT_FEATURE.md` - هذا الملف

### ملفات محدثة:
- `lib/screens/home_screen.dart` - إضافة التعامل مع إغلاق التطبيق وتهيئة Method Channel
- `lib/app.dart` - تحديثات بسيطة للدعم
- `windows/runner/flutter_window.cpp` - إضافة معالج رسائل Windows
- `windows/runner/flutter_window.h` - تحديثات للدعم

## التقنيات المستخدمة

### Windows Native Code
```cpp
case WM_CLOSE: {
  // Notify Flutter about window close event
  if (flutter_controller_ && flutter_controller_->engine()) {
    auto channel = std::make_unique<flutter::MethodChannel<flutter::EncodableValue>>(
        flutter_controller_->engine()->messenger(),
        "app_lifecycle",
        &flutter::StandardMethodCodec::GetInstance());
    
    channel->InvokeMethod("windowClosing", nullptr);
  }
  
  // Don't close immediately, let Flutter handle it
  return 0;
}
```

### Method Channel في Flutter
```dart
static const MethodChannel _channel = MethodChannel('app_lifecycle');

static Future<dynamic> _handleMethodCall(MethodCall call) async {
  switch (call.method) {
    case 'windowClosing':
      await _handleWindowClosing();
      break;
  }
}
```

### تهيئة الخدمة
```dart
@override
void initState() {
  super.initState();
  _loadAllData();
  
  // تهيئة خدمة Method Channel لنظام Windows
  WidgetsBinding.instance.addPostFrameCallback((_) {
    WindowsMethodChannelService.initialize(context);
  });
}
```

## النسخ الاحتياطي
- **التخزين**: يتم رفع النسخ الاحتياطية إلى Supabase Storage
- **تنظيف تلقائي**: يتم الاحتفاظ بآخر 10 نسخ احتياطية
- **تسمية الملفات**: `backup_YYYY-MM-DDTHH-MM-SS.db`
- **حجم البيانات**: ملف قاعدة البيانات SQLite الكامل

## إعدادات Supabase المطلوبة
- تأكد من أن bucket اسمه موجود في Supabase Storage
- تأكد من صحة إعدادات الاتصال في `lib/config/supabase_config.dart`
- تأكد من وجود صلاحيات الكتابة في الـ bucket

## الأمان والموثوقية
- **منع التشغيل المتزامن**: لا يمكن تشغيل أكثر من نسخة احتياطية في نفس الوقت
- **التعامل مع الأخطاء**: عرض رسائل خطأ واضحة عند فشل العملية
- **إمكانية الإلغاء**: يمكن للمستخدم إلغاء عملية الخروج
- **تأكيد المستخدم**: لا يتم الخروج إلا بعد موافقة صريحة من المستخدم
- **التقاط الأحداث على مستوى النظام**: يتم التقاط زر الإغلاق (X) من Windows مباشرة

## تدفق العملية التقنية

1. **المستخدم يضغط زر الإغلاق (X)**
2. **Windows يرسل WM_CLOSE إلى التطبيق**
3. **C++ Code يتقاط الرسالة ويرسل "windowClosing" إلى Flutter**
4. **Flutter يعرض حوار التأكيد**
5. **إذا وافق المستخدم، يبدأ النسخ الاحتياطي**
6. **بعد اكتمال النسخ الاحتياطي، يتم إرسال "forceClose" إلى C++**
7. **C++ Code يغلق النافذة نهائياً**

## حل المشاكل

### إذا لم يعمل زر الإغلاق (X):
1. تأكد من أن ملف `flutter_window.cpp` تم تحديثه بشكل صحيح
2. تأكد من أن التطبيق تم بناؤه من جديد بعد التحديثات
3. تأكد من أن `WindowsMethodChannelService` تم تهيئته في `home_screen.dart`

### إذا فشل النسخ الاحتياطي:
1. تحقق من اتصال الإنترنت
2. تحقق من إعدادات Supabase
3. تحقق من صلاحيات الـ bucket

### إذا تجمد التطبيق:
1. تحقق من وجود حلقات لا نهائية في الكود
2. تحقق من أن `forceClose` يتم استدعاؤه بشكل صحيح

## ملاحظات
- هذه الميزة مخصصة لتطبيق Windows Desktop
- تتطلب اتصال إنترنت لرفع النسخة الاحتياطية
- في حالة فشل النسخ الاحتياطي، لن يتم إغلاق التطبيق تلقائياً
- يمكن تخطي النسخ الاحتياطي بالضغط على "إلغاء"
- يتم التقاط جميع محاولات إغلاق النافذة بما في ذلك Alt+F4 وزر الإغلاق (X)

## الاختبار
لاختبار الميزة:
1. قم بتشغيل التطبيق: `flutter run -d windows`
2. اضغط على زر الإغلاق (X) في النافذة
3. يجب أن يظهر حوار التأكيد للنسخ الاحتياطي
4. اختر "متابعة مع النسخ الاحتياطي" لاختبار العملية الكاملة
